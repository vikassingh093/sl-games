
const http = require('http');
const WebSocket = require('ws');
const url = require('url');
var fs = require('fs');
var socket = require('socket.io');
var request = require('request');

var serverConfig;
serverConfig = JSON.parse(fs.readFileSync(__dirname + '/../public/socket_config.json', 'utf8'));

function base64ToArrayBuffer(base64) {
    return Buffer.from(base64, "hex");
}

if (serverConfig.ssl) {
    var privateKey = fs.readFileSync('/etc/letsencrypt/live/vedhagames.com/privkey.pem', 'utf8');
    var certificate = fs.readFileSync('/etc/letsencrypt/live/vedhagames.com/fullchain.pem', 'utf8');

    var credentials = { key: privateKey, cert: certificate };
    var https = require('https');

    var server = https.createServer(credentials);
}
else {
    var server = http.createServer();
}

const ws_slots = new WebSocket.Server({ noServer: true });
const authWs = new WebSocket.Server({ noServer: true });
const ws_firelinks = new WebSocket.Server({ noServer: true });
const pingWs = new WebSocket.Server({ noServer: true });
const ws_bragg = new WebSocket.Server({ noServer: true });


/**
 * Start of Noble Games 
 */
const socketio_noble = socket(server, {
    pingInterval: 60000,
    pingTimeout: 30000,
    transports: ["websocket", "polling"],
    cors:{
        origin: serverConfig.prefix + serverConfig.host,
        methods:["GET", "POST"],
        credentials: true
    },
    allowEIO3: true
});

socketio_noble.on('connection', function(socket){
    socket.emit('connected');    
    var responseCmds = {
        'LoginGame' : 'loginGameResult',
        'lottery' : 'lotteryResult',        
    }

    function sendMessageToServer(cmd, data)
    {
        var data = JSON.parse(data);
        var gameName = data.gameName;
        var ck = data.cookie;
        var gameURL = serverConfig.prefix + serverConfig.host + '/game/' + gameName + '/server';
        data.cookie = '';
        data.cmd = cmd; 

        var paramStr = JSON.stringify(data);

        var options = {
            method: 'post',
            body: data,
            json: true,
            rejectUnauthorized: false,
            requestCert: false,
            agent: false,
            url: gameURL,
            headers: {
                'Connection': 'keep-alive',
                "Content-Type": "application/json",
                'Content-Length': paramStr.length,
                'Cookie': ck
            }
        }

        request(options, function (err, res, body) {
            if (err) {
                console.log('Error :', err);
                return;
            }
            // console.log(body);
            socket.emit(responseCmds[cmd], body);     
            if(body.nGamblingWinPool)
            {
                socket.emit('pushGamblingWinPool', {ResultCode: 1, nGamblingWinPool: body.nGamblingWinPool});
            }
        });
    }

    socket.on('LoginGame', async function(data){        
        sendMessageToServer('LoginGame', data);        
    });
    socket.on('lottery', async function(data){        
        sendMessageToServer('lottery', data);        
    });
    socket.on('heart_beat', async function(data){        
        var response = {
            'ResultCode' : 1,
            'time' : (new Date()).getTime()
        }
        socket.emit('heart_beat', response);        
    });
});

/**
 * End of Noble Games 
 */

/**
 * Start of Bragg Games 
 */
var bragg_sockets = [];
ws_bragg.on('connection', function connection(ws) {    
    ws.on('message', function incoming(message) {
        try {            
            var gameName = '';
            message = message.toString();
            if (message.split(":::")[1] != undefined) {
                try {
                    var param = JSON.parse(message.split(":::")[1]);
                } catch (e) { console.log(e); return; }

                var ck = decodeURI(param.cookie);
                var sessionId = param.sessionId;
                param.cookie = '';

                gameName = param.gameName;
            }
            else {
                var param = {};
                var ck = '';
            }

            var gameURL = serverConfig.prefix + serverConfig.host + '/game/' + gameName + '/server?&sessionId=' + sessionId;

            if (gameName == undefined) {
                console.log(param);
                return;
            }

            if(param.gameData.header.name == 'Ping')
                return;
            if(param.gameData.header.name == 'ClientSyncRegister')
            {
                bragg_sockets.push(ws);
                return;
            }

            var paramStr = JSON.stringify(param);
            var options = {
                method: 'post',
                body: param,
                json: true,
                rejectUnauthorized: false,
                requestCert: false,
                agent: false,
                url: gameURL,
                headers: {
                    'Connection': 'keep-alive',
                    "Content-Type": "application/json",
                    'Content-Length': paramStr.length,
                    'Cookie': ck
                }
            }

            request(options, function (err, res, body) {
                if (err) {
                    console.log('Error :', err);
                    return;
                }

                if (body != undefined) {
                    try {
                        var allReq = body.toString().split("------");
                    }
                    catch (e) {
                        console.log('Error :', e)
                        return;
                    }

                    for (var i = 0; i < allReq.length; i++) {
                        ws.send(allReq[i]);
                    }
                }
            });
        } catch (exception) {
            console.log('Error: ', exception);
        }
    });

    ws.on('close', async (error) => {
        for(var i = 0; i < bragg_sockets.length; i++)
        {
            if(bragg_sockets[i] === ws)
            {
                bragg_sockets.splice(i, 1);
                break;
            }
        }
    });

    ws.send('1::');
});

setInterval(() => {
    for(var i = 0; i < bragg_sockets.length; i++)
    {
        var ws = bragg_sockets[i];
        ws.send(':::{"header":{"mId":8,"cId":51329,"name":"Ping","dType":2}}');        
    }
}, 20 * 1000);

/**
 * End of Bragg Games 
 */


/**
 * Start of General Slot Games 
 */

ws_slots.on('connection', function connection(ws) {
    ws.on('message', function incoming(message) {
        try {            
            var gameName = '';
            message = message.toString();
            if (message.split(":::")[1] != undefined) {
                try {
                    var param = JSON.parse(message.split(":::")[1]);
                } catch (e) { console.log(e); return; }

                var ck = decodeURI(param.cookie);
                var sessionId = param.sessionId;
                param.cookie = '';

                gameName = param.gameName;
            }
            else {
                var param = {};
                var ck = '';
            }

            var gameURL = serverConfig.prefix + serverConfig.host + '/game/' + gameName + '/server?&sessionId=' + sessionId;

            if (gameName == undefined) {
                console.log(param);
                return;
            }

            var paramStr = JSON.stringify(param);

            var options = {
                method: 'post',
                body: param,
                json: true,
                rejectUnauthorized: false,
                requestCert: false,
                agent: false,
                url: gameURL,
                headers: {
                    'Connection': 'keep-alive',
                    "Content-Type": "application/json",
                    'Content-Length': paramStr.length,
                    'Cookie': ck
                }
            }

            request(options, function (err, res, body) {
                if (err) {
                    console.log('Error :', err);
                    return;
                }

                if (body != undefined) {
                    try {
                        var allReq = body.toString().split("------");
                    }
                    catch (e) {
                        console.log('Error :', e)
                        return;
                    }

                    for (var i = 0; i < allReq.length; i++) {
                        ws.send(allReq[i]);
                    }
                }
            });
        } catch (exception) {
            console.log('Error: ', exception);
        }
    });
    ws.send('1::');
});

/**
 * End of General Slot Games 
 */

authWs.on('connection', function connection(ws) {
    let cnt = 0;
    ws.on('message', function message(data) {
        switch (cnt) {
            case 0:
                try {
                    let msg = JSON.parse(data);
                    let token = msg.token;
                    let type = msg.type;
                    let body = msg.body;
                    var params = [];
                    params.push({
                        "type": "login"
                    });
                    params.push({
                        "body": ""
                    });
                    SendMessageToPHP(ws, params, token, "NorthShore");
                } catch (e) { }
                break;
            case 1:
                ws.send(base64ToArrayBuffer("0180200003002b02a413d044d8f03f40f3b359f5b9c57b40d4421cebe27d9440dd88635dbc23b440"));
                break;
            case 2:
                ws.send(base64ToArrayBuffer("2000640b650064000300000010007c007c000100060006000000000000000200000000000000020000002d4efd565788c9623897000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000670061006d0065005f00730067006c0079005f007300650072007600650072002e006500780065000000000000000000000000000000000000000000000000000300000010006b006b0001000600000000000000000000000000000000000100000055637c9c2759a84e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000670061006d0065005f00730067006c0079005f007300650072007600650072002e006500780065000000000000000000000000000000000000000000000000000300000010000a000a00010006000100000000000000000000000000000001000000695f0374000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000670061006d0065005f00730067006c0079005f007300650072007600650072002e006500780065000000000000000000000000000000000000000000000000000300000010007d007d00010006000200000000000000000000000000000002000000bb94f377c96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000670061006d0065005f00730067006c0079005f007300650072007600650072002e006500780065000000000000000000000000000000000000000000000000000300000010006c006c0001000600000000000000000000000000000000000100000055637c9cff7ee85dba4e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000670061006d0065005f00730067006c0079005f007300650072007600650072002e006500780065000000000000000000000000000000000000000000000000000300000010000b000b00010006000000000000000000000000000000000001000000a27edd84037400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000670061006d0065005f00730067006c0079005f007300650072007600650072002e006500780065000000000000000000000000000000000000000000000000000300000010007e007e00010006000200000000000000040000000000000002000000d191b194c96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000670061006d0065005f00730067006c0079005f007300650072007600650072002e006500780065000000000000000000000000000000000000000000000000000300000010007f007f000100060002000000000000000000000000000000020000006f703c7bc96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000670061006d0065005f00730067006c0079005f007300650072007600650072002e0065007800650000000000000000000000000000000000000000000000000003000000100077007700010006000100000000000000000000000000000002000000346c9c67504eed560000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000670061006d0065005f00730067006c0079005f007300650072007600650072002e00650078006500000000000000000000000000000000000000000000000000030000001000800080000100060003000000000000000000000000000000020000001753776db85cc9623897000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000670061006d0065005f00730067006c0079005f007300650072007600650072002e0065007800650000000000000000000000000000000000000000000000000003000000100078007800010006000100000000000000000000000000000002000000a8526972c96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000670061006d0065005f00730067006c0079005f007300650072007600650072002e0065007800650000000000000000000000000000000000000000000000000003000000100081008100010006000200000000000000000000000000000002000000228dcc5b4b4e3c77c962389700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000670061006d0065005f00730067006c0079005f007300650072007600650072002e00650078006500000000000000000000000000000000000000000000000000030000001000790079000100060001000000000000000000000000000000020000006b700374c96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000670061006d0065005f00730067006c0079005f007300650072007600650072002e00650078006500000000000000000000000000000000000000000000000000030000001000820082000100060004000000000000000000000000000000020000008776b65b27595390c962389700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000670061006d0065005f00730067006c0079005f007300650072007600650072002e00650078006500000000000000000000000000000000000000000000000000030000001000c900c9000100060000000000000000000000000000000000020000005b72d44ec96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000670061006d0065005f00730067006c0079005f007300650072007600650072002e006500780065000000000000000000000000000000000000000000000000000300000010007a007a00010006000000000000000000000000000000000002000000d191999fc96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000670061006d0065005f00730067006c0079005f007300650072007600650072002e00650078006500000000000000000000000000000000000000000000000000030000001000ca00ca00010006000400000000000000000000000000000002000000255fd2525b4fc9623897000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000670061006d0065005f00730067006c0079005f007300650072007600650072002e006500780065000000000000000000000000000000000000000000000000000300000010007b007b000100060001000000000000000000000000000000020000006c51ef8dc96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000670061006d0065005f00730067006c0079005f007300650072007600650072002e00650078006500000000000000000000000000000000000000000000000000"));
                break;
            case 3:
                //ws.send(base64ToArrayBuffer("0000300c6500650081000000f4011100010001000100e31d000000000000f03f00000000000000000000000000000049400000000302000000000000003c000000340037002e00390030002e003100380039002e003200340036000000000000000000000000000000000000000000000000000000000000000000000000000000228dcc5b4b4e3c77c962389700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00000000007e000000f4010b00010001000100dd1d000000000000f03f00000000000000000000000000000049400000000302000000000000003c000000340037002e00390030002e003100380039002e003200340036000000000000000000000000000000000000000000000000000000000000000000000000000000d191b194c96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c001b0000007c000000f4010800010001000100da1d000000000000f03f00000000000000000000000000000049400000000306000000000000003c000000340037002e00390030002e003100380039002e0032003400360000000000000000000000000000000000000000000000000000000000000000000000000000002d4efd565788c9623897000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00370000007a000000f4010500010001000100d71d000000000000f03f00000000000000000000000000000049400000000300000000000000003c000000340037002e00390030002e003100380039002e003200340036000000000000000000000000000000000000000000000000000000000000000000000000000000d191999fc96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c000000000078000000f4010200010001000100d41d000000000000f03f00000000000000000000000000000049400000000301000000000000003c000000340037002e00390030002e003100380039002e003200340036000000000000000000000000000000000000000000000000000000000000000000000000000000a8526972c96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c000000000080000000f4011000010001000100e21d000000000000f03f00000000000000000000000000000049400000000303000000000000003c000000340037002e00390030002e003100380039002e0032003400360000000000000000000000000000000000000000000000000000000000000000000000000000001753776db85cc9623897000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00000000007f000000f4010d00010001000100df1d000000000000f03f00000000000000000000000000000049400000000302000000000000003c000000340037002e00390030002e003100380039002e0032003400360000000000000000000000000000000000000000000000000000000000000000000000000000006f703c7bc96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00000000007d000000f4010a00010001000100dc1d000000000000f03f00000000000000000000000000000049400000000302000000000000003c000000340037002e00390030002e003100380039002e003200340036000000000000000000000000000000000000000000000000000000000000000000000000000000bb94f377c96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00000000006c000000f4010700010001000100d91d000000000000f03f0000000000000000000000000000004940000000030000000000000000f0000000340037002e00390030002e003100380039002e00320034003600000000000000000000000000000000000000000000000000000000000000000000000000000055637c9cff7ee85dba4e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00000000006b000000f4010400010001000100d61d000000000000f03f0000000000000000000000000000004940000000030000000000000000f0000000340037002e00390030002e003100380039002e00320034003600000000000000000000000000000000000000000000000000000000000000000000000000000055637c9c2759a84e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c000000000077000000f4010100010001000100d31d000000000000f03f00000000000000000000000000000022400000000301000000000000003c000000340037002e00390030002e003100380039002e003200340036000000000000000000000000000000000000000000000000000000000000000000000000000000346c9c67c96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c000000000082000000f4011200010001000100e41d000000000000f03f00000000000000000000000000000049400000000304000000000000003c000000340037002e00390030002e003100380039002e0032003400360000000000000000000000000000000000000000000000000000000000000000000000000000008776b65b27595390c962389700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c0000000000ca000000f4010f00010001000100e11d000000000000f03f00000000000000000000000000000049400000000304000000000000003c000000340037002e00390030002e003100380039002e003200340036000000000000000000000000000000000000000000000000000000000000000000000000000000255fd2525b4fc9623897000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00000000000a000000f4010900010001000100db1d000000000000f03f00000000000000000000000000000049400000000301000000000000003c000000340037002e00390030002e003100380039002e003200340036000000000000000000000000000000000000000000000000000000000000000000000000000000695f0374000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00000000007b000000f4010600010001000100d81d000000000000f03f00000000000000000000000000000049400000000301000000000000003c000000340037002e00390030002e003100380039002e0032003400360000000000000000000000000000000000000000000000000000000000000000000000000000006c51ef8dc96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c000000000079000000f4010300010001000100d51d000000000000f03f00000000000000000000000000000049400000000301000000000000003c000000340037002e00390030002e003100380039002e0032003400360000000000000000000000000000000000000000000000000000000000000000000000000000006b700374c96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c0000000000"));
                ws.send(base64ToArrayBuffer("003ca91a6500650029000000f4012000010001000100f21d000000000000144000000000000000000000000000000049400000000300000000000000002c010000340037002e00390030002e003100330033002e003100360031000000000000000000000000000000000000000000000000000000000000000000000000000000276b326d6e8fd8762d4e3a5700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00000000006f000000f4011d00010001000100ef1d000000000000f03f0000000000000000000000000000004940000000030000000000000000f0000000340037002e00390030002e003100330033002e00310036003100000000000000000000000000000000000000000000000000000000000000000000000000000055637c9cd191fe870000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c000000000088000000f4011a00010001000100ec1d000000000000f03f00000000000000000000000000000049400000000301000000000000003c000000340037002e00390030002e003100330033002e003100360031000000000000000000000000000000000000000000000000000000000000000000000000000000776d7e6ec96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00000000006e000000f4011700010001000100e91d000000000000f03f0000000000000000000000000000004940000000030100000000000000f0000000340037002e00390030002e003100330033002e00310036003100000000000000000000000000000000000000000000000000000000000000000000000000000055637c9c6b70fc720000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c000000000084000000f4011400010001000100e61d000000000000f03f00000000000000000000000000000049400000000302000000000000003c000000340037002e00390030002e003100330033002e0031003600310000000000000000000000000000000000000000000000000000000000000000000000000000001663ff77c96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c000000000081000000f4011100010001000100e31d000000000000f03f00000000000000000000000000000049400000000300000000000000003c000000340037002e00390030002e003100330033002e003100360031000000000000000000000000000000000000000000000000000000000000000000000000000000228dcc5b4b4e3c77c962389700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00000000007e000000f4010b00010001000100dd1d000000000000f03f00000000000000000000000000000049400000000305000000000000003c000000340037002e00390030002e003100330033002e003100360031000000000000000000000000000000000000000000000000000000000000000000000000000000d191b194c96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00170000007c000000f4010800010001000100da1d000000000000f03f00000000000000000000000000000049400000000302000000000000003c000000340037002e00390030002e003100330033002e0031003600310000000000000000000000000000000000000000000000000000000000000000000000000000002d4efd565788c9623897000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c006a0000007a000000f4010500010001000100d71d000000000000f03f00000000000000000000000000000049400000000300000000000000003c000000340037002e00390030002e003100330033002e003100360031000000000000000000000000000000000000000000000000000000000000000000000000000000d191999fc96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c000000000078000000f4010200010001000100d41d000000000000f03f00000000000000000000000000000049400000000302000000000000003c000000340037002e00390030002e003100330033002e003100360031000000000000000000000000000000000000000000000000000000000000000000000000000000a8526972c96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00000000000c000000f4012200010001000100f41d000000000000f03f00000000000000000000000000000049400000000303000000000000003c000000340037002e00390030002e003100330033002e003100360031000000000000000000000000000000000000000000000000000000000000000000000000000000858da77e037400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c000000000029000000f4011f00010001000100f11d000000000000f03f00000000000000000000000000000049400000000300000000000000002c010000340037002e00390030002e003100330033002e003100360031000000000000000000000000000000000000000000000000000000000000000000000000000000276b326d6e8fd8760f5c3a5700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00000000008c000000f4011c00010001000100ee1d000000000000f03f00000000000000000000000000000049400000000303000000000000003c000000340037002e00390030002e003100330033002e003100360031000000000000000000000000000000000000000000000000000000000000000000000000000000b065346c9c67c9623897000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c000000000087000000f4011900010001000100eb1d000000000000f03f00000000000000000000000000000049400000000303000000000000003c000000340037002e00390030002e003100330033002e003100360031000000000000000000000000000000000000000000000000000000000000000000000000000000b051dd5dc96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c000000000085000000f4011600010001000100e81d000000000000f03f00000000000000000000000000000049400000000301000000000000003c000000340037002e00390030002e003100330033002e003100360031000000000000000000000000000000000000000000000000000000000000000000000000000000b79ac59a3459c9623897000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c000000000083000000f4011300010001000100e51d000000000000f03f00000000000000000000000000000049400000000300000000000000003c000000340037002e00390030002e003100330033002e003100360031000000000000000000000000000000000000000000000000000000000000000000000000000000995baf65c96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c000000000080000000f4011000010001000100e21d000000000000f03f00000000000000000000000000000049400000000302000000000000003c000000340037002e00390030002e003100330033002e0031003600310000000000000000000000000000000000000000000000000000000000000000000000000000001753776db85cc9623897000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00000000007f000000f4010d00010001000100df1d000000000000f03f00000000000000000000000000000049400000000300000000000000003c000000340037002e00390030002e003100330033002e0031003600310000000000000000000000000000000000000000000000000000000000000000000000000000006f703c7bc96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00000000007d000000f4010a00010001000100dc1d000000000000f03f00000000000000000000000000000049400000000301000000000000003c000000340037002e00390030002e003100330033002e003100360031000000000000000000000000000000000000000000000000000000000000000000000000000000bb94f377c96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00000000006c000000f4010700010001000100d91d000000000000f03f0000000000000000000000000000004940000000030200000000000000f0000000340037002e00390030002e003100330033002e00310036003100000000000000000000000000000000000000000000000000000000000000000000000000000055637c9cff7ee85dba4e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00000000006b000000f4010400010001000100d61d000000000000f03f0000000000000000000000000000004940000000030100000000000000f0000000340037002e00390030002e003100330033002e00310036003100000000000000000000000000000000000000000000000000000000000000000000000000000055637c9c2759a84e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c000000000072000000f4012400010001000100f61d000000000000f03f0000000000000000000000000000004940000000030000000000000000f0000000340037002e00390030002e003100330033002e00310036003100000000000000000000000000000000000000000000000000000000000000000000000000000055637c9cee728b730000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c000000000077000000f4010100010001000100d31d000000000000f03f00000000000000000000000000000022400000000303000000000000003c000000340037002e00390030002e003100330033002e003100360031000000000000000000000000000000000000000000000000000000000000000000000000000000346c9c67c96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c000000000029000000f4012100010001000100f31d000000000000594000000000000000000000000000000049400000000300000000000000002c010000340037002e00390030002e003100330033002e003100360031000000000000000000000000000000000000000000000000000000000000000000000000000000276b326d6e8fd87627593a5700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00000000008d000000f4011e00010001000100f01d000000000000f03f00000000000000000000000000000049400000000300000000000000003c000000340037002e00390030002e003100330033002e003100360031000000000000000000000000000000000000000000000000000000000000000000000000000000ce915b72c96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c000000000071000000f4011b00010001000100ed1d000000000000f03f0000000000000000000000000000004940000000030000000000000000f0000000340037002e00390030002e003100330033002e00310036003100000000000000000000000000000000000000000000000000000000000000000000000000000055637c9c6b70929e9f9e000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c000000000086000000f4011800010001000100ea1d000000000000f03f00000000000000000000000000000049400000000301000000000000003c000000340037002e00390030002e003100330033002e003100360031000000000000000000000000000000000000000000000000000000000000000000000000000000b073d191c96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00000000006d000000f4011500010001000100e71d000000000000f03f0000000000000000000000000000004940000000030000000000000000f0000000340037002e00390030002e003100330033002e00310036003100000000000000000000000000000000000000000000000000000000000000000000000000000055637c9cd191999f7c9c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c000000000082000000f4011200010001000100e41d000000000000f03f00000000000000000000000000000049400000000302000000000000003c000000340037002e00390030002e003100330033002e0031003600310000000000000000000000000000000000000000000000000000000000000000000000000000008776b65b27595390c962389700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c0000000000ca000000f4010f00010001000100e11d000000000000f03f00000000000000000000000000000049400000000301000000000000003c000000340037002e00390030002e003100330033002e003100360031000000000000000000000000000000000000000000000000000000000000000000000000000000255fd2525b4fc9623897000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c0000000000c9000000f4010c00010001000100de1d000000000000f03f00000000000000000000000000000049400000000300000000000000003c000000340037002e00390030002e003100330033002e0031003600310000000000000000000000000000000000000000000000000000000000000000000000000000005b72d44ec96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00000000000a000000f4010900010001000100db1d000000000000f03f00000000000000000000000000000049400000000302000000000000003c000000340037002e00390030002e003100330033002e003100360031000000000000000000000000000000000000000000000000000000000000000000000000000000695f0374000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00000000007b000000f4010600010001000100d81d000000000000f03f00000000000000000000000000000049400000000301000000000000003c000000340037002e00390030002e003100330033002e0031003600310000000000000000000000000000000000000000000000000000000000000000000000000000006c51ef8dc96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c000000000079000000f4010300010001000100d51d000000000000f03f00000000000000000000000000000049400000000300000000000000003c000000340037002e00390030002e003100330033002e0031003600310000000000000000000000000000000000000000000000000000000000000000000000000000006b700374c96238970000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c00000000008e000000f4012300010001000100f51d000000000000f03f00000000000000000000000000000049400000000300000000000000003c000000340037002e00390030002e003100330033002e003100360031000000000000000000000000000000000000000000000000000000000000000000000000000000a27ea38f1269c9623897000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003c0000000000/ocAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8AAAAAACIAAAA9AEaAAEAAQABAOwdAAAAAAAA8D8AAAAAAAAAAAAAAAAAAABJQAAAAAMBAAAAAAAAADwAAAA0ADcALgA5ADAALgAxADMAMwAuADEANgAxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAd21+bsliOJcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8AAAAAABuAAAA9AEXAAEAAQABAOkdAAAAAAAA8D8AAAAAAAAAAAAAAAAAAABJQAAAAAMBAAAAAAAAAPAAAAA0ADcALgA5ADAALgAxADMAMwAuADEANgAxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAVWN8nGtw/HIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA8AAAAAACEAAAA9AEUAAEAAQABAOYdAAAAAAAA8D8AAAAAAAAAAAAAAAAAAABJQAAAAAMCAAAAAAAAADwAAAA0ADcALgA5ADAALgAxADMAMwAuADEANgAxAAAAAAAAAAAAAA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"));
                break;
            case 4:
                ws.send(base64ToArrayBuffer("004100006500c800"));
                break;
            case 5:
                ws.send(base64ToArrayBuffer("2000010403002c02000000000000000087e6e2d8f40000003093a208f40000003093a20800000000000000000000000024f8c7023093a208f400000094f8c702010000007cf8c7025a20375c5893a208147a3a5cafe6e2d82093a208a0f8c70240cf3a5cffffffffacf8c702d31d375cd1105b37ec000000d0f8c702ec000000b8f8c7025a20375c0893a208147a3a5c6be6e2d8f892a208dcf8c70240cf3a5cffffffffe8f8c7024171375c95105b37e812a2084c12a208e400000028d33a5c000000000093a20870fcc702898e385c0000000000fbc702b975e500bd02000003002f0110f9c702c575e5001c2ca60803000000b87b5600f412a208770061006c00740065006900730068006100310031003200000000000000000000000000000000000000000000000000000000000000000000000000000000000000770061006c007400650069007300680061007700310031003200000000000000000000000000000000000000000000000000000000000000000000000000000000002f59bbe031003600330037003100370035003400330037003300370033003100370000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c2ca60801000000200073007a004100630063006f0075006e007400730020003d0020002000e567e28be34e06746c514a544900440020003a4e200032003200330031000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d4e82e7340fcc7020239e50075010000f412a20804000000e539e50001000000b87b5600b87b56007b7646960d67056e6496a973b65b3a00320031003800330031002000305740571aff340037002e00fb129777e8dbd701000000002e00320032003400db649d77050000000000000068a3e8dbec649d7740a99375f0fbc70201568e000000726d39010000e8dbd7010500000068a3e8db8405959a0700000002dab435f0fbc715c8fbc702f8fbc70208fcc70218fcc70254e9f7717ddfad7c092a3a00809698000000000001568e000000000001568e007d5fec510000000018fcc702e6e8f771e812a2084c12a2083856956100000000d41c33180000000024fcc70200"));
                break;
        }
        cnt++;
    });
});

pingWs.on('connection', function connection(ws) {
    ws.on('message', function message(data) {
        let msg = JSON.parse(data);
        let token = msg.token;
        var params = [];
        params.push({
            "type": "ping"
        });
        params.push({
            "body": ''
        });
        SendMessageToPHP(ws, params, token, "Community");
    })
});


ws_firelinks.on('connection', function connection(ws) {
    let heartbeatIndex = 0;
    let gameType = ws.Cookie;
    ws.on('message', function message(data) {
        try {
            let msg = JSON.parse(data);
            let token = msg.token;
            let type = msg.type;
            let body = msg.body;
            var params = [];
            params.push({
                "type": type
            });
            params.push({
                "body": body
            });
            let binaryData = "";
            switch (type) {
                case 'transScore':
                    var params = [];
                    params.push({
                        "type": "transScore"
                    });
                    params.push({
                        "body": body
                    });
                    SendMessageToPHP(ws, params, token, gameType);
                    break;
                case 'login':
                    binaryData = base64ToArrayBuffer("54500800010064000000000000000000");
                    ws.send(binaryData);
                    break;
                case 'heartbeat':
                    switch (heartbeatIndex) {
                        case 0:
                            binaryData = base64ToArrayBuffer("54500a00020065003c00010001001009f003");
                            ws.send(binaryData);
                            break;
                        case 1:
                            binaryData = base64ToArrayBuffer("00d0000002006700");
                            ws.send(binaryData);
                            break;
                        case 2:
                            var params = [];
                            params.push({
                                "type": "subLogin"
                            });
                            params.push({
                                "body": ""
                            });
                            SendMessageToPHP(ws, params, token, gameType)
                            break;
                        case 3:
                            binaryData = base64ToArrayBuffer("6c78000001006600");
                            ws.send(binaryData);
                            break;
                        case 4:
                            binaryData = base64ToArrayBuffer("40806a01040064003c00000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000000001000000");
                            ws.send(binaryData);
                            break;
                        case 5:
                            binaryData = base64ToArrayBuffer("00d00900030066005f2800000100000003");
                            ws.send(binaryData);
                            break;
                        case 6:
                            binaryData = base64ToArrayBuffer("00d00900030066005f2800000100000005");
                            ws.send(binaryData);
                            break;
                        case 7:
                            binaryData = base64ToArrayBuffer("00d01c0003006500c55900000000000000c6ab40b9000000920100000000000000000000");
                            ws.send(binaryData);
                            break;
                        case 8:
                            binaryData = base64ToArrayBuffer("00d00200640064000000");
                            ws.send(binaryData);
                            break;
                        case 9:
                            binaryData = base64ToArrayBuffer("0a009001c800670001000000010000000100000001000000010000000200000002000000020000000200000002000000000000000000000000000000000000000000000003000000030000000300000003000000030000000100000002000000030000000200000001000000020000000100000000000000010000000200000000000000010000000200000001000000000000000300000002000000010000000200000003000000020000000300000002000000030000000200000001000000000000000100000000000000010000000100000001000000020000000300000003000000020000000200000001000000000000000000000003000000020000000200000002000000030000000000000001000000010000000100000000000000010000000200000001000000000000000100000002000000010000000200000003000000020000000100000000000000000000000100000002000000020000000300000003000000020000000100000001000000020000000200000002000000010000000200000001000000010000000100000002000000");
                            ws.send(binaryData);
                            break;
                        case 10:
                            binaryData = base64ToArrayBuffer("0000c800c8006a000a00000011000000090000000e0000000c0000000d0000000d000000110000000000000000000000100000000b0000000c000000110000000a0000000b000000090000001000000000000000000000000a0000000e0000000a000000110000000e0000000c0000000d0000001000000000000000000000000e0000000f000000100000000a000000100000000b000000110000000c00000000000000000000000f000000090000000b00000010000000110000000a0000000b000000110000000000000000000000");
                            ws.send(binaryData);
                            break;
                        case 11:
                            var params = [];
                            params.push({
                                "type": "jackpot"
                            });
                            params.push({
                                "body": ""
                            });
                            SendMessageToPHP(ws, params, token, gameType)
                            break;
                        case 12:
                            var params = [];
                            params.push({
                                "type": "cashable"
                            });
                            params.push({
                                "body": ""
                            });
                            SendMessageToPHP(ws, params, token, gameType)
                            break;
                        case 13:
                            binaryData = base64ToArrayBuffer("01983000c800cb00000000000000000000000000000000000000f03f3200000000000000000000000000f03f000000000000494000000000");
                            ws.send(binaryData);
                            break;
                        case 14:
                            binaryData = base64ToArrayBuffer("01982000c8006d000000000000000000000000000000000000000000000000000000000000000000");
                            ws.send(binaryData);
                            break;
                        case 15:
                            binaryData = base64ToArrayBuffer("0198610064006500880200000000000000020000000000000050c30000000000000a00000000000000010000000000000005000000000000000a00000000000000140000000000000000000000006a084100000000006a084100000000801fc2400000000000000000");
                            ws.send(binaryData);
                            break;
                        case 16:
                            binaryData = base64ToArrayBuffer("0198000000000100");
                            ws.send(binaryData);
                            break;
                        // default:
                        //     params = [];
                        //     params.push({
                        //         "type":"heartbeat"
                        //     });
                        //     params.push({
                        //         "body":body
                        //     });
                        //     SendMessageToPHP(ws,params,token);
                        //     break;
                    }
                    if (heartbeatIndex < 17) {
                        heartbeatIndex++;
                    }
                    break;
                case "betChange":
                    SendMessageToPHP(ws, params, token, gameType);
                    break;
                case "spin":
                    var params = [];
                    params.push({
                        "type": "spin"
                    });
                    params.push({
                        "body": body
                    });
                    SendMessageToPHP(ws, params, token, gameType);
                    break;
                case "wait_bonus":
                    var params = [];
                    params.push({
                        "type": "wait_bonus"
                    });
                    params.push({
                        "body": body
                    });
                    SendMessageToPHP(ws, params, token, gameType);
                    break;
                case "wait_special":
                    var params = [];
                    params.push({
                        "type": "wait_special"
                    });
                    params.push({
                        "body": body
                    });
                    SendMessageToPHP(ws, params, token, gameType);
                    break;
                case "choice_card":
                    var params = [];
                    params.push({
                        "type": "choice_card"
                    });
                    params.push({
                        "body": body
                    });
                    SendMessageToPHP(ws, params, token, gameType);
                    break;
            }
        } catch (e) {

        }
    });
});

function SendMessageToPHP(ws, params, token, gameName) {
    var request = require('request');
    var gameURL = serverConfig.prefix + serverConfig.host + '/game/' + gameName + '/server';
    var tokenArry = token.split(";");
    for (let k = 0; k < tokenArry.length; k++) {
        if (tokenArry[k].includes("store")) {
            token = token.replace(tokenArry[k] + ';', '');
        }

        if (tokenArry[k].includes("pin")) {
            token = token.replace(tokenArry[k] + ';', '');
        }
    }
    var options = {
        method: 'post',
        body: params,
        json: true,
        rejectUnauthorized: false,
        requestCert: false,
        agent: false,
        url: gameURL,
        headers: {
            'Cookie': token,
        }
    }
    if (gameName == 'Ping' || gameName == 'CommunityPrize') {
        request(options, function (err, res, body) {
            if (err) {
                console.log('Error :', err)
            }
            try {
                if (body.message.includes('Maximum execution time')) {
                    ws.send('{"main":200,"type": 201,"body":""}');
                }
            } catch (e) {

            }
            try {
                ws.send(body);

            } catch (e) {
                console.error(e);
            }
            return;
        });
    } else {
        request(options, function (err, res, body) {
            if (err) {
                console.log('Error :', err)
            }
            try {
                if (body.message.includes('Maximum execution time')) {
                    ws.send('{"main":200,"type": 201,"body":""}');
                }
            } catch (e) {

            }
            try {
                if (body != "" && Array.isArray(body)) {
                    for (let i = 0; i < body.length; i++) {
                        if (JSON.parse(body[i]).main == 200) {
                            var data = JSON.parse(body[i]);
                            if (data.type == 101) {
                                var shop_id = data.body.shop_id;
                                ws.shop_id = shop_id;
                                ws_firelinks.clients.forEach(function each(client) {
                                    if (client.readyState === WebSocket.OPEN && client.shop_id == shop_id && client != ws) {
                                        client.send(body[i]);
                                    }
                                });
                            }
                            ws.send(body[i]);
                        }
                        else {
                            ws.send(body[i]);
                        }

                    }
                } else {
                    ws.send(JSON.stringify(body));
                }
            } catch (e) {
                console.error(e);
            }
            return;
        });
    }
}

server.on('upgrade', function upgrade(request, socket, head) {
    const pathname = url.parse(request.url).pathname;
    if (pathname === '/NorthShore_Auth') {
        authWs.handleUpgrade(request, socket, head, function done(ws) {
            authWs.emit('connection', ws, request);
        });

    }
    else if (pathname === '/NorthShore') {
        ws_firelinks.handleUpgrade(request, socket, head, function done(ws) {
            ws.Cookie = "NorthShore";
            ws_firelinks.emit('connection', ws, request);
        });
    }
    else if (pathname === '/RueRoyale') {
        ws_firelinks.handleUpgrade(request, socket, head, function done(ws) {
            ws.Cookie = "RueRoyale";
            ws_firelinks.emit('connection', ws, request);
        });
    }
    else if (pathname === '/RiverWalk') {
        ws_firelinks.handleUpgrade(request, socket, head, function done(ws) {
            ws.Cookie = "RiverWalk";
            ws_firelinks.emit('connection', ws, request);
        });
    }
    else if (pathname === '/Route66') {
        ws_firelinks.handleUpgrade(request, socket, head, function done(ws) {
            ws.Cookie = "Route66";
            ws_firelinks.emit('connection', ws, request);
        });
    }
    else if (pathname === '/OlveraStreet') {
        ws_firelinks.handleUpgrade(request, socket, head, function done(ws) {
            ws.Cookie = "OlveraStreet";
            ws_firelinks.emit('connection', ws, request);
        });
    }
    else if (pathname === '/ChinaStreet') {
        ws_firelinks.handleUpgrade(request, socket, head, function done(ws) {
            ws.Cookie = "ChinaStreet";
            ws_firelinks.emit('connection', ws, request);
        });
    }
    else if (pathname == '/ByTheBay') {
        ws_firelinks.handleUpgrade(request, socket, head, function done(ws) {
            ws.Cookie = "ByTheBay";
            ws_firelinks.emit('connection', ws, request);
        });
    }
    else if (pathname == '/GlacierGold') {
        ws_firelinks.handleUpgrade(request, socket, head, function done(ws) {
            ws.Cookie = "GlacierGold";
            ws_firelinks.emit('connection', ws, request);
        });
    }
    else if (pathname == '/DragonLink') {
        ws_firelinks.handleUpgrade(request, socket, head, function done(ws) {
            ws.Cookie = "DragonLink";
            ws_firelinks.emit('connection', ws, request);
        });
    }    
    else if (pathname === '/ping') {
        pingWs.handleUpgrade(request, socket, head, function done(ws) {
            ws.Cookie = "Ping";
            pingWs.emit('connection', ws, request);
        });
    }
    else if (pathname === '/slots') {
        ws_slots.handleUpgrade(request, socket, head, function done(ws) {
            ws_slots.emit('connection', ws, request);
        });
    }
    else if (pathname === '/bragg') {
        ws_bragg.handleUpgrade(request, socket, head, function done(ws) {
            ws_bragg.emit('connection', ws, request);
        });
    }
    else {
        socket.destroy();
    }
});

server.listen(serverConfig.port.split("/")[0]);


